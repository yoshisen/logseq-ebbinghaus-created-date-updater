
name: release

on:
  push:
    tags:
      - "v*.*.*"            # ã‚¿ã‚° vX.Y.Z ã‚’ push ã—ãŸã¨ãã«è‡ªå‹•å®Ÿè¡Œ
  workflow_dispatch:         # æ‰‹å‹•å®Ÿè¡Œãƒˆãƒªã‚¬ãƒ¼
    inputs:
      tag:
        description: "æ—¢å­˜ã‚¿ã‚°ï¼ˆä¾‹: v0.1.12ï¼‰ã‚’æŒ‡å®š"
        required: true
        type: string
      build_from:
        description: "ãƒ“ãƒ«ãƒ‰å…ƒ: 'tag'ï¼ˆå³å¯†ï¼‰ ã¾ãŸã¯ 'main'ï¼ˆæŸ”è»Ÿï¼‰"
        required: true
        type: choice
        options:
          - tag
          - main
        default: tag

permissions:
  contents: write            # Release ä½œæˆã®ãŸã‚ã«å¿…è¦

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: æ±ºå®š: checkout ã™ã‚‹ ref
        id: ref_decider
        shell: bash
        run: |
          # æ‰‹å‹•å®Ÿè¡Œã®å ´åˆã€é¸æŠã«å¿œã˜ã¦ ref ã‚’æ±ºå®š
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ "${{ inputs.build_from }}" == "tag" ]]; then
              echo "ref=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
            else
              # main ã‹ã‚‰ãƒ“ãƒ«ãƒ‰ â†’ ç©ºå€¤ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ–ãƒ©ãƒ³ãƒã‚’ä½¿ç”¨ï¼ˆå¿…è¦ãªã‚‰ 'main' ã‚’ç›´æ›¸ãå¯ï¼‰
              echo "ref=" >> "$GITHUB_OUTPUT"
            fi
          else
            # pushï¼ˆã‚¿ã‚°ï¼‰ã‚¤ãƒ™ãƒ³ãƒˆã¯ checkout å´ã®å¼ã§å‡¦ç†ã™ã‚‹ãŸã‚ç©º
            echo "ref=" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout
        uses: actions/checkout@v4
        with:
          # æ‰‹å‹•(tag) â†’ ä¸Šã®ã‚¹ãƒ†ãƒƒãƒ—ã§æ±ºå®šã—ãŸã‚¿ã‚°
          # push(tag) â†’ ç¾åœ¨ã®ã‚¿ã‚°
          # æ‰‹å‹•(main) â†’ ç©ºå€¤ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ–ãƒ©ãƒ³ãƒ
          ref: ${{ steps.ref_decider.outputs.ref || (github.ref_type == 'tag' && github.ref_name) || '' }}

      - name: ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®ç¢ºèª
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Ref type: ${{ github.ref_type }}"
          echo "Ref name: ${{ github.ref_name }}"
          pwd
          ls -la
          # å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«æ¤œæŸ»ã€‚tag ã‹ã‚‰ãƒ“ãƒ«ãƒ‰ã™ã‚‹å ´åˆã€ãã®ã‚¿ã‚°ã« lockfile ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¿…è¦ã‚ã‚Š
          test -f package.json && echo "âœ… package.json found" || (echo "âŒ missing package.json" && exit 1)
          test -f package-lock.json && echo "âœ… package-lock.json found" || (echo "âŒ missing package-lock.json"; echo "ğŸ‘‰ build_from='tag' ã®å ´åˆã€å¯¾è±¡ã‚¿ã‚°ã« lockfile ãŒå¿…è¦ã§ã™"; exit 1)

      - name: Node.js ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ãƒ“ãƒ«ãƒ‰
        run: npm run build

      - name: é…å¸ƒç”¨ zip ä½œæˆ
        run: |
          zip -r plugin.zip \
            dist \
            package.json \
            README.md \
            LICENSE \
            icon.png \
            manifest.json

      # --- Release ä½œæˆ ---

      - name: Release ä½œæˆï¼ˆè‡ªå‹•: ã‚¿ã‚° pushï¼‰
        if: ${{ github.ref_type == 'tag' && github.event_name == 'push' }}
        uses: softprops/action-gh-release@v2
        with:
          files: plugin.zip
          name: "${{ github.ref_name }}"
          overwrite: true
          body: |
            Automated release for ${{ github.ref_name }}.
            Includes built plugin.zip (dist + manifest + icon + docs).

      - name: Release ä½œæˆï¼ˆæ‰‹å‹•: tag ã‹ã‚‰ãƒ“ãƒ«ãƒ‰ï¼‰
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.build_from == 'tag' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "${{ inputs.tag }}"
          files: plugin.zip
          name: "${{ inputs.tag }}"
          overwrite: true
          body: |
            Manual release for existing tag: ${{ inputs.tag }} (built from tag code).
            Includes built plugin.zip (dist + manifest + icon + docs).

      - name: Release ä½œæˆï¼ˆæ‰‹å‹•: main ã‹ã‚‰ãƒ“ãƒ«ãƒ‰ï¼‰
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.build_from == 'main' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "${{ inputs.tag }}"
          files: plugin.zip
          name: "${{ inputs.tag }}"
          overwrite: true
          body: |
            Manual release for existing tag: ${{ inputs.tag }} (built from main).
            Includes built plugin.zip (dist + manifest + icon + docs).
