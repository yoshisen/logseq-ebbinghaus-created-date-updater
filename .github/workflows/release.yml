
name: release

on:
  push:
    tags:
      - "v*.*.*"           
  workflow_dispatch:
    inputs:
      tag:
        description: "Existing tag to (re)publish, e.g. v0.1.12"
        required: true
        type: string
      build_from:
name: release

on:
  push:
    tags:
      - "v*.*.*"            
  workflow_dispatch:
    inputs:
      tag:
        description: "Existing tag to (re)publish, e.g. v0.1.12"
        required: true
        type: string
      build_from:
        description: "Build source: 'tag' (strict) or 'main' (flexible)"
        required: true
        type: choice
        options:
          - tag
          - main
        default: tag

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.build_from == 'tag' && inputs.tag || (github.ref_type == 'tag' && github.ref_name) || '' }}

      - name: Debug workspace
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Ref type: ${{ github.ref_type }}"
          echo "Ref name: ${{ github.ref_name }}"
          pwd
          ls -la
          test -f package.json && echo "‚úÖ package.json found" || (echo "‚ùå missing package.json" && exit 1)
          test -f package-lock.json && echo "‚úÖ package-lock.json found" || (echo "‚ùå missing package-lock.json"; echo "üëâ If you build_from='tag', the tag must include lockfile."; exit 1)

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Build plugin
        run: npm run build

      - name: Create zip artifact
        run: |
          zip -r plugin.zip \
            dist \
            package.json \
            README.md \
            LICENSE \
            icon.png \
            manifest.json

      - name: Create Release (auto: tag push)
        if: ${{ github.ref_type == 'tag' && github.event_name == 'push' }}
        uses: softprops/action-gh-release@v2
        with:
          files: plugin.zip
          name: "${{ github.ref_name }}"
          overwrite: true
          body: |
            Automated release for ${{ github.ref_name }}.
            Includes built plugin.zip (dist + manifest + icon + docs).


      - name: Create Release (manual: build from tag)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.build_from == 'tag' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "${{ inputs.tag }}"
          files: plugin.zip
          name: "${{ inputs.tag }}"
          overwrite: true
          body: |
            Manual release for existing tag: ${{ inputs.tag }} (built from tag code).
            Includes built plugin.zip (dist + manifest + icon + docs).

      - name: Create Release (manual: build from main)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.build_from == 'main' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "${{ inputs.tag }}"
          files: plugin.zip
          name: "${{ inputs.tag }}"
          overwrite: true
          body: |
            Manual release for existing tag: ${{ inputs.tag }} (built from main).
            Includes built plugin.zip (dist + manifest + icon + docs).

        description: "Build source: 'tag' (strict) or 'main' (flexible)"
        required: true
        type: choice
        options:
          - tag
          - main
        default: tag

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.build_from == 'tag' && inputs.tag || (github.ref_type == 'tag' && github.ref_name) || '' }}

      - name: Debug workspace
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Ref type: ${{ github.ref_type }}"
          echo "Ref name: ${{ github.ref_name }}"
          pwd
          ls -la
          test -f package.json && echo "‚úÖ package.json found" || (echo "‚ùå missing package.json" && exit 1)
          test -f package-lock.json && echo "‚úÖ package-lock.json found" || (echo "‚ùå missing package-lock.json"; echo "üëâ If you build_from='tag', the tag must include lockfile."; exit 1)

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Build plugin
        run: npm run build

      - name: Create zip artifact
        run: |
          zip -r plugin.zip \
            dist \
            package.json \
            README.md \
            LICENSE \
            icon.png \
            manifest.json

      - name: Create Release (manual: build from main)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.build_from == 'main' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "${{ inputs.tag }}"
          files: plugin.zip
          name: "${{ inputs.tag }}"
          overwrite: true
          body: |
            Manual release for existing tag: ${{ inputs.tag }} (built from main).
            Includes built plugin.zip (dist + manifest + icon + docs).
