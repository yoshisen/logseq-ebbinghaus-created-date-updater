
name: release

on:
  push:
    tags:
      - "v*.*.*"            # æ—¥æœ¬èª: tag ãŒ vX.Y.Z å½¢å¼ã§ push ã•ã‚ŒãŸã¨ãã«è‡ªå‹•å®Ÿè¡Œ
  workflow_dispatch:         # æ—¥æœ¬èª: æ‰‹å‹•å®Ÿè¡Œç”¨ãƒˆãƒªã‚¬ãƒ¼
    inputs:
      tag:
        description: "æ—¢å­˜ã®ã‚¿ã‚° (ä¾‹: v0.1.12) ã‚’æŒ‡å®šã—ã¦å†å…¬é–‹"
        required: true
        type: string
      build_from:
        description: "ãƒ“ãƒ«ãƒ‰å…ƒ: 'tag'ï¼ˆå³å¯†ï¼‰ã¾ãŸã¯ 'main'ï¼ˆæŸ”è»Ÿï¼‰"
        required: true
        type: choice
        options:
          - tag
          - main
        default: tag

permissions:
  contents: write            # æ—¥æœ¬èª: Release ä½œæˆã®ãŸã‚ã« contents: write ãŒå¿…è¦

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Decide checkout ref (for workflow_dispatch)
        id: ref_decider
        shell: bash
        run: |
          # æ—¥æœ¬èª: æ‰‹å‹•å®Ÿè¡Œæ™‚ã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã™ã‚‹ ref ã‚’æ±ºå®š
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ "${{ inputs.build_from }}" == "tag" ]]; then
              # æ—¥æœ¬èª: tag ã‹ã‚‰å³å¯†ã«ãƒ“ãƒ«ãƒ‰ã™ã‚‹å ´åˆã€inputs.tag ã‚’ä½¿ç”¨
              echo "ref=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
            else
              # æ—¥æœ¬èª: main ã‹ã‚‰æŸ”è»Ÿã«ãƒ“ãƒ«ãƒ‰ã™ã‚‹å ´åˆã€ç©ºã«ã—ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ–ãƒ©ãƒ³ãƒã‚’ä½¿ç”¨ï¼ˆå¿…è¦ãªã‚‰æ˜ç¤ºçš„ã« main ã¨æŒ‡å®šã—ã¦ã‚‚OKï¼‰
              echo "ref=" >> "$GITHUB_OUTPUT"
            fi
          else
            # æ—¥æœ¬èª: pushï¼ˆtagï¼‰ã‚¤ãƒ™ãƒ³ãƒˆæ™‚ã¯ checkout ã‚¹ãƒ†ãƒƒãƒ—å´ã®å¼ã§å‡¦ç†ã™ã‚‹ãŸã‚ã“ã“ã§ã¯ç©º
            echo "ref=" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout
        uses: actions/checkout@v4
        with:
          # æ—¥æœ¬èª:
          # - æ‰‹å‹•å®Ÿè¡Œã‹ã¤ tag ãƒ“ãƒ«ãƒ‰ â†’ ä¸Šã®ã‚¹ãƒ†ãƒƒãƒ—ã§æ±ºã‚ãŸ inputs.tag
          # - pushï¼ˆtagï¼‰ã‚¤ãƒ™ãƒ³ãƒˆ â†’ ç¾åœ¨ã®ã‚¿ã‚°ï¼ˆgithub.ref_type == 'tag' ã®ã¨ã github.ref_nameï¼‰
          # - ãã‚Œä»¥å¤–ï¼ˆæ‰‹å‹• main ãªã©ï¼‰ â†’ ç©ºã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ–ãƒ©ãƒ³ãƒ
          ref: ${{ steps.ref_decider.outputs.ref || (github.ref_type == 'tag' && github.ref_name) || '' }}

      - name: Debug workspace
        run: |
          # æ—¥æœ¬èª: å®Ÿè¡Œã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ç¢ºèª
          echo "Event: ${{ github.event_name }}"
          echo "Ref type: ${{ github.ref_type }}"
          echo "Ref name: ${{ github.ref_name }}"
          pwd
          ls -la

          # æ—¥æœ¬èª: å¿…è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèªã€‚tag ã‹ã‚‰ãƒ“ãƒ«ãƒ‰ã™ã‚‹å ´åˆã¯ lockfile ãŒã‚¿ã‚°ã«å«ã¾ã‚Œã¦ã„ã‚‹å¿…è¦ã‚ã‚Š
          test -f package.json && echo "âœ… package.json found" || (echo "âŒ missing package.json" && exit 1)
          test -f package-lock.json && echo "âœ… package-lock.json found" || (echo "âŒ missing package-lock.json"; echo "ğŸ‘‰ build_from='tag' ã®å ´åˆã€å¯¾è±¡ã‚¿ã‚°ã« lockfile ãŒå¿…è¦ã§ã™"; exit 1)

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20" # æ—¥æœ¬èª: Node.js 20 ã‚’ä½¿ç”¨

      - name: Install dependencies
        run: npm ci            # æ—¥æœ¬èª: lockfile ã«åŸºã¥ãã‚¯ãƒªãƒ¼ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

      - name: Build plugin
        run: npm run build     # æ—¥æœ¬èª: ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰

      - name: Create zip artifact
        run: |
          # æ—¥æœ¬èª: é…å¸ƒç”¨ zip ã‚’ä½œæˆ
          zip -r plugin.zip \
            dist \
            package.json \
            README.md \
            LICENSE \
            icon.png \
            manifest.json

      # --- Release ä½œæˆãƒ•ã‚§ãƒ¼ã‚º ---

      - name: Create Release (auto: tag push)
        if: ${{ github.ref_type == 'tag' && github.event_name == 'push' }}
        uses: softprops/action-gh-release@v2
        with:
          files: plugin.zip
          name: "${{ github.ref_name }}"
          overwrite: true
          body: |
            Automated release for ${{ github.ref_name }}.
            Includes built plugin.zip (dist + manifest + icon + docs).

      - name: Create Release (manual: build from tag)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.build_from == 'tag' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "${{ inputs.tag }}"
          files: plugin.zip
          name: "${{ inputs.tag }}"
          overwrite: true
          body: |
            Manual release for existing tag: ${{ inputs.tag }} (built from tag code).
            Includes built plugin.zip (dist + manifest + icon + docs).

      - name: Create Release (manual: build from main)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.build_from == 'main' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "${{ inputs.tag }}"  # æ—¥æœ¬èª: æ—¢å­˜ã‚¿ã‚°ã¸ä¸Šæ›¸ãå…¬é–‹ï¼ˆä¸Šæ›¸ãã¯ overwrite: true ã§åˆ¶å¾¡ï¼‰
          files: plugin.zip
          name: "${{ inputs.tag }}"
          overwrite: true
          body: |
            Manual release for existing tag: ${{ inputs.tag }} (built from main).
            Includes built plugin.zip (dist + manifest + icon + docs).
